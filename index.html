<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bioreactor & Parameter Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 12px;
            background-color: #f0f2f5;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .desktop-frame {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: stretch;
            width: 100%;
            max-width: 1700px;
            margin: 0 auto;
            min-height: calc(100vh - 24px);
            border: 2px solid #cccccc;
            border-radius: 10px;
            padding: 16px;
            gap: 16px;
            background-color: #ffffff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .col-left  { flex: 1; display: flex; justify-content: center; align-items: stretch; max-width: 480px; }
        .col-center { flex: 1.4; display: flex; justify-content: center; align-items: stretch; }
        .col-right  { flex: 1; display: flex; flex-direction: column; gap: 14px; justify-content: space-between; align-items: stretch; max-width: 460px; }

        .parameter-box {
            background-color: #f4f5f7;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 16px;
            width: 100%;
            overflow: visible;
        }

        /* ---- BIOREACTOR ---- */
        .bio-dashboard {
            display: flex; flex-direction: column; gap: 16px;
            justify-content: center; align-items: center;
            height: 100%;
        }
        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 420px;
            flex: 1;
            min-height: 380px;
            border-radius: 12px; padding: 4px;
            background: linear-gradient(90deg,#ff0000,#ff7300,#fffb00,#48ff00,#00ffd5,#002bff,#7a00ff,#ff00c8,#ff0000);
            background-size: 200% 200%; animation: rgbGlow 3s linear infinite;
        }
        @keyframes rgbGlow { 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
        canvas {
            display: block; width: 100%; height: 100%;
            background: radial-gradient(circle at center,#ffffff 0%,#e2e8f0 100%);
            border-radius: 9px;
        }
        .bio-controls-wrapper { width: 100%; }
        .bio-controls-wrapper h2 {
            margin-top: 0; font-size: 14px; color: #555; text-align: center;
            border-bottom: 1px solid #dcdcdc; padding-bottom: 8px; margin-bottom: 12px;
            font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
        }
        .bio-controls { display: flex; flex-direction: row; gap: 16px; width: 100%; justify-content: center; }
        .control-group {
            flex: 1; background: #ffffff; padding: 12px; border-radius: 6px;
            border: 1px solid #e0e0e0; text-align: center;
        }
        .control-group.aeration { border-left: 4px solid #2ecc71; }
        .control-group.impeller { border-left: 4px solid #0082c8; }
        .control-title {
            font-weight: 700; font-size: 11px; letter-spacing: 1.5px;
            text-transform: uppercase; margin-bottom: 8px; color: #333;
        }
        .value-display {
            font-size: 16px; font-weight: 900; color: #0082c8; margin-bottom: 8px;
            display: flex; justify-content: center; gap: 5px; align-items: baseline;
        }
        .value-display.aeration { color: #2ecc71; }
        .unit-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #555; }

        /* ---- 4-BUTTON DIGITAL CONTROLLER ---- */
        .mini-controller {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            border-radius: 8px; padding: 7px; border: 1px solid #bcbcbc;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin: 0 auto; width: 100%;
        }
        .mini-panel {
            background-color: #6a6a6a; border-radius: 5px; padding: 7px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.4);
        }
        .mini-screen {
            background-color: #050505; border: 2px solid #333; border-radius: 4px;
            padding: 5px 10px; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 7px; height: 42px;
        }
        .mini-screen-value {
            font-family: 'Orbitron', monospace; font-size: 1.4rem;
            color: #1aff1a; text-shadow: 0 0 10px rgba(26,255,26,0.7);
            letter-spacing: 1px; line-height: 1; transition: color 0.2s, text-shadow 0.2s;
        }
        .mini-screen-value.off-glow {
            color: #0a3a0a; text-shadow: none;
        }
        .mini-screen-unit {
            font-size: 0.85rem; color: #ff1a1a; font-weight: bold;
            text-shadow: 0 0 8px rgba(255,26,26,0.8); line-height: 1; font-family: Arial, sans-serif;
        }
        .mini-screen-unit.off-unit {
            color: #3a0a0a; text-shadow: none;
        }
        .four-btn-row {
            display: flex; justify-content: space-between; gap: 4px;
        }
        .ctrl-btn {
            background: linear-gradient(to bottom,#0056b3,#002d5f);
            border: 1.5px solid #001a33; border-radius: 5px; cursor: pointer;
            box-shadow: 0 3px 4px rgba(0,0,0,0.5), inset 0 3px 2px rgba(255,255,255,0.4), inset 0 -2px 3px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            flex: 1; height: 36px; transition: transform 0.05s, background 0.2s;
            color: white; font-weight: 900; font-size: 1rem; user-select: none; padding: 0;
            -webkit-user-select: none; touch-action: none; -webkit-tap-highlight-color: transparent;
        }
        .ctrl-btn:active {
            transform: translateY(2px);
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.6);
            background: #001a33;
        }
        .ctrl-btn.pwr-btn.is-off {
            background: linear-gradient(to bottom,#444,#222);
            border-color: #111;
            box-shadow: 0 1px 2px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.1);
        }
        .ctrl-btn.set-btn {
            font-size: 0.6rem; letter-spacing: 1px;
            font-family: Arial, sans-serif; font-weight: 900;
        }
        @keyframes setFlash {
            0%,100% { background: linear-gradient(to bottom,#0056b3,#002d5f); }
            50%      { background: linear-gradient(to bottom,#27ae60,#1e8449); box-shadow: 0 0 12px #27ae60; }
        }
        .set-btn.flashing { animation: setFlash 0.35s ease-in-out 2; }

        /* ---- PUMPS GRID ---- */
        .pumps-grid {
            display: grid; grid-template-columns: repeat(2,1fr);
            grid-template-rows: repeat(2,1fr); gap: 12px;
            width: 100%; padding: 8px;
        }
        .pump-card {
            background-color: #ffffff; border: 1px solid #dcdcdc; border-radius: 6px;
            padding: 10px; display: flex; flex-direction: column; align-items: center;
            justify-content: space-between; height: 280px;
        }
        .pump-title {
            font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px;
            border-bottom: 2px solid #eee; padding-bottom: 3px; width: 100%;
            text-align: center; letter-spacing: 1px;
        }
        .pump-svg-container { width: 100%; max-width: 110px; margin-bottom: 3px; }
        @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
        @keyframes flow { from{stroke-dashoffset:200} to{stroke-dashoffset:0} }
        .rotor-system { transform-origin: 200px 200px; animation: spin 6s linear infinite; }
        .arrows { stroke-dasharray: 20 80; animation: flow 3s linear infinite; }
        .pump-speed-label { font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: #555; margin-bottom: 2px; }
        .pump-rpm-display { font-size: 14px; font-weight: 900; color: #0082c8; margin-bottom: 4px; display: flex; gap: 4px; align-items: baseline; }
        .pump-card .mini-screen-value { font-size: 1.1rem; }
        .pump-card .ctrl-btn { height: 30px; font-size: 0.85rem; }
        .pump-card .ctrl-btn.set-btn { font-size: 0.55rem; }
        .pump-card .mini-screen { height: 38px; }

        /* ---- THERMAL ---- */
        .thermo-section {
            display: flex; flex-direction: row; gap: 16px;
            align-items: center; justify-content: center; flex: 1;
        }
        .thermo-container {
            position: relative; width: 90px; height: 220px;
            background: #ecf0f3; border-radius: 45px; padding: 8px; flex-shrink: 0;
            box-shadow: 6px 6px 15px #d1d9e6, -6px -6px 15px #ffffff;
            border: 2px solid #ffffff; display: flex; justify-content: center; align-items: center;
        }
        .thermo-container svg { width: 100%; height: 100%; }
        .tick-label  { font-size: 13px; font-weight: 800; fill: #5e6b7e; font-family: 'Courier New', monospace; }
        .major-tick  { stroke: #4a5568; stroke-width: 3.5; stroke-linecap: round; }
        .minor-tick  { stroke: #a0aec0; stroke-width: 1.5; stroke-linecap: round; }
        .unit-header { font-size: 22px; font-weight: 900; fill: #2d3748; }
        .fluid { transition: height 0.5s cubic-bezier(0.175,0.885,0.32,1.275), y 0.5s cubic-bezier(0.175,0.885,0.32,1.275), fill 0.4s ease-in-out; }
        .glass-highlight { pointer-events: none; opacity: 0.6; }
        .thermo-controls { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .readout {
            display: flex; flex-direction: column; justify-content: center; gap: 6px;
            align-items: flex-start; background: #ffffff; border-radius: 8px;
            border: 1px solid #e0e0e0; padding: 10px 14px; width: 100%;
        }
        .temp-row { display: flex; align-items: baseline; gap: 6px; }
        .temp-num { font-size: 28px; font-weight: 900; color: #1a202c; letter-spacing: -1px; line-height: 1; }
        .temp-unit-sym { font-size: 18px; font-weight: 900; color: #e53e3e; line-height: 1; }
        .temp-label { font-size: 10px; color: #718096; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; margin-top: 2px; }
        .temp-divider { width: 100%; height: 1px; background: #edf2f7; }

        /* ---- pH ---- */
        .ph-section {
            text-align: center; display: flex; flex-direction: column;
            align-items: center; justify-content: center; flex: 1;
        }
        .ph-svg-container { width: 100%; display: flex; justify-content: center; margin-bottom: 4px; }
        .ph-svg-container svg { width: 100%; max-width: 270px; height: auto; overflow: visible; }
        #arrow-group { transition: transform 0.3s cubic-bezier(0.25,0.8,0.25,1); }
        .ph-controls {
            width: 100%; background: #ffffff; border-radius: 8px;
            border: 1px solid #e0e0e0; padding: 10px;
        }
        .ph-value-display { font-size: 0.95rem; font-weight: bold; color: #333; margin-bottom: 6px; }
        .ph-value-display span { color: #0082c8; font-size: 1.2rem; }
    </style>
</head>
<body>
<div class="desktop-frame">

    <!-- ========== LEFT: 4 PUMP CARDS ========== -->
    <div class="col-left">
        <div class="pumps-grid parameter-box" id="pumpControlsContainer"></div>
    </div>

    <!-- ========== CENTER: BIOREACTOR ========== -->
    <div class="col-center">
        <div class="bio-dashboard parameter-box">
            <div class="canvas-container">
                <canvas id="reactorCanvas" width="420" height="520"></canvas>
            </div>
            <div class="bio-controls-wrapper">
                <h2>System Controls</h2>
                <div class="bio-controls">

                    <!-- IMPELLER -->
                    <div class="control-group impeller">
                        <div class="control-title">Impeller RPM</div>
                        <div class="value-display" id="impellerValueDisplay">0 <span class="unit-label">RPM</span></div>
                        <div class="mini-controller">
                            <div class="mini-panel">
                                <div class="mini-screen">
                                    <div class="mini-screen-value" id="impellerScreen">0</div>
                                    <div class="mini-screen-unit" id="impellerUnit">RPM</div>
                                </div>
                                <div class="four-btn-row">
                                    <button class="ctrl-btn pwr-btn" id="impellerPwr" title="Power/Off">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                                    </button>
                                    <button class="ctrl-btn" id="impellerUp">▲</button>
                                    <button class="ctrl-btn" id="impellerDown">▼</button>
                                    <button class="ctrl-btn set-btn" id="impellerSet">SET</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AERATION -->
                    <div class="control-group aeration">
                        <div class="control-title">O2 Aeration</div>
                        <div class="value-display aeration" id="aerationValueDisplay">0 <span class="unit-label">%</span></div>
                        <div class="mini-controller">
                            <div class="mini-panel">
                                <div class="mini-screen">
                                    <div class="mini-screen-value" id="aerationScreen">0</div>
                                    <div class="mini-screen-unit" id="aerationUnit">%</div>
                                </div>
                                <div class="four-btn-row">
                                    <button class="ctrl-btn pwr-btn" id="aerationPwr" title="Power/Off">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                                    </button>
                                    <button class="ctrl-btn" id="aerationUp">▲</button>
                                    <button class="ctrl-btn" id="aerationDown">▼</button>
                                    <button class="ctrl-btn set-btn" id="aerationSet">SET</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- ========== RIGHT: TEMP + pH ========== -->
    <div class="col-right">

        <!-- TEMPERATURE -->
        <div class="thermo-section parameter-box">
            <div class="thermo-container">
                <svg viewBox="0 0 240 600">
                    <defs>
                        <linearGradient id="tubeDepth" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#cbd5e0"/>
                            <stop offset="50%" stop-color="#ffffff"/>
                            <stop offset="100%" stop-color="#a0aec0"/>
                        </linearGradient>
                        <linearGradient id="shine" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="white" stop-opacity="0.9"/>
                            <stop offset="40%" stop-color="white" stop-opacity="0.1"/>
                            <stop offset="100%" stop-color="white" stop-opacity="0"/>
                        </linearGradient>
                    </defs>
                    <rect x="25" y="20" width="190" height="560" rx="95" ry="95" fill="#f7fafc" stroke="#edf2f7" stroke-width="2"/>
                    <g id="scaleLines"></g>
                    <text x="85" y="65" text-anchor="middle" class="unit-header">°C</text>
                    <text x="155" y="65" text-anchor="middle" class="unit-header">°F</text>
                    <rect x="110" y="85" width="20" height="410" rx="10" ry="10" fill="url(#tubeDepth)"/>
                    <rect id="fluidCol" x="110" y="495" width="20" height="0" rx="10" ry="10" class="fluid" fill="#3182ce"/>
                    <circle id="bulbFluid" cx="120" cy="505" r="22" class="fluid" fill="#3182ce"/>
                    <rect x="113" y="90" width="5" height="400" rx="2.5" fill="url(#shine)" class="glass-highlight"/>
                    <circle cx="114" cy="497" r="8" fill="white" fill-opacity="0.3" class="glass-highlight"/>
                </svg>
            </div>
            <div class="thermo-controls">
                <div class="readout">
                    <div class="temp-row">
                        <div id="cVal" class="temp-num">0.0</div>
                        <div class="temp-unit-sym">°C</div>
                    </div>
                    <div class="temp-label">Celsius</div>
                    <div class="temp-divider"></div>
                    <div class="temp-row" style="margin-top:4px;">
                        <div id="fVal" class="temp-num">32.0</div>
                        <div class="temp-unit-sym">°F</div>
                    </div>
                    <div class="temp-label">Fahrenheit</div>
                </div>
                <div class="mini-controller" style="width:100%;">
                    <div class="mini-panel">
                        <div class="mini-screen">
                            <div class="mini-screen-value" id="tempScreen">0.0</div>
                            <div class="mini-screen-unit" id="tempUnit">°C</div>
                        </div>
                        <div class="four-btn-row">
                            <button class="ctrl-btn pwr-btn" id="tempPwr" title="Power/Off">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                            </button>
                            <button class="ctrl-btn" id="tempUp">▲</button>
                            <button class="ctrl-btn" id="tempDown">▼</button>
                            <button class="ctrl-btn set-btn" id="tempSet">SET</button>
                        </div>
                    </div>
                </div>
                <p style="margin:4px 0 0;font-size:9px;font-weight:800;color:#a0aec0;letter-spacing:2px;text-align:center;">TEMP CONTROL</p>
            </div>
        </div>

        <!-- pH -->
        <div class="ph-section parameter-box">
            <div class="ph-svg-container">
                <svg id="ph-meter" viewBox="0 0 600 320"></svg>
            </div>
            <div class="ph-controls">
                <div class="ph-value-display">pH Level: <span id="current-val">0.0</span></div>
                <div class="mini-controller" style="width:100%;">
                    <div class="mini-panel">
                        <div class="mini-screen">
                            <div class="mini-screen-value" id="phScreen">0.0</div>
                            <div class="mini-screen-unit" id="phUnit">pH</div>
                        </div>
                        <div class="four-btn-row">
                            <button class="ctrl-btn pwr-btn" id="phPwr" title="Power/Off">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                            </button>
                            <button class="ctrl-btn" id="phUp">▲</button>
                            <button class="ctrl-btn" id="phDown">▼</button>
                            <button class="ctrl-btn set-btn" id="phSet">SET</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
/* ================================================================
   UNIVERSAL CONTROLLER FACTORY
   Power ON  → screen glows, buttons active, value stays
   Power OFF → screen goes dark, value shows 0, ▲▼ disabled
   Hold ▲/▼  → auto-repeat
================================================================ */
function makeController({ pwrId, upId, downId, setId, screenId, unitId,
    initValue, min, max, step, decimals, onUpdate }) {

    const dec_    = decimals || 0;
    // Use integer "ticks" internally to avoid all floating-point drift
    const SCALE   = Math.round(Math.pow(10, dec_));
    const minTick = Math.round(min * SCALE);
    const maxTick = Math.round(max * SCALE);
    const stepTick = Math.round((step || 1) * SCALE);

    // Internal tick counter — stable integer math only
    let ticks  = Math.round(initValue * SCALE);
    let isOn   = true;

    // Exposed state object (read-only for callers)
    const state = {
        get on()    { return isOn; },
        get value() { return ticks / SCALE; }
    };

    const screen  = document.getElementById(screenId);
    const unitEl  = unitId ? document.getElementById(unitId) : null;
    const pwrBtn  = document.getElementById(pwrId);
    const upBtn   = document.getElementById(upId);
    const downBtn = document.getElementById(downId);
    const setBtn  = document.getElementById(setId);

    let holdTimer    = null;
    let holdInterval = null;
    let isHolding    = false;

    function renderScreen() {
        if (isOn) {
            screen.textContent = (ticks / SCALE).toFixed(dec_);
            screen.classList.remove('off-glow');
            if (unitEl) unitEl.classList.remove('off-unit');
        } else {
            screen.textContent = (0).toFixed(dec_);
            screen.classList.add('off-glow');
            if (unitEl) unitEl.classList.add('off-unit');
        }
        pwrBtn.classList.toggle('is-off', !isOn);
    }

    function notify() {
        renderScreen();
        if (onUpdate) onUpdate(state);
    }

    function stepUp() {
        if (!isOn) return;
        ticks = Math.min(maxTick, ticks + stepTick);
        notify();
    }
    function stepDown() {
        if (!isOn) return;
        ticks = Math.max(minTick, ticks - stepTick);
        notify();
    }

    function startHold(fn) {
        if (isHolding) return;
        isHolding = true;
        fn();
        holdTimer = setTimeout(() => {
            holdInterval = setInterval(fn, 100);
        }, 450);
    }
    function stopHold() {
        if (!isHolding) return;
        clearTimeout(holdTimer);
        clearInterval(holdInterval);
        holdTimer    = null;
        holdInterval = null;
        isHolding    = false;
    }

    // Touch events — preventDefault stops ghost mouse events firing after touch
    upBtn.addEventListener('touchstart',    (e) => { e.preventDefault(); startHold(stepUp);   }, { passive: false });
    upBtn.addEventListener('touchend',      (e) => { e.preventDefault(); stopHold(); },           { passive: false });
    upBtn.addEventListener('touchcancel',   (e) => { e.preventDefault(); stopHold(); },           { passive: false });
    downBtn.addEventListener('touchstart',  (e) => { e.preventDefault(); startHold(stepDown); }, { passive: false });
    downBtn.addEventListener('touchend',    (e) => { e.preventDefault(); stopHold(); },           { passive: false });
    downBtn.addEventListener('touchcancel', (e) => { e.preventDefault(); stopHold(); },           { passive: false });

    // Mouse events (desktop only — on mobile these are blocked by preventDefault above)
    upBtn.addEventListener('mousedown',    () => startHold(stepUp));
    upBtn.addEventListener('mouseup',      () => stopHold());
    upBtn.addEventListener('mouseleave',   () => stopHold());
    downBtn.addEventListener('mousedown',  () => startHold(stepDown));
    downBtn.addEventListener('mouseup',    () => stopHold());
    downBtn.addEventListener('mouseleave', () => stopHold());

    // Global safety net
    document.addEventListener('mouseup',     () => stopHold());
    document.addEventListener('touchend',    () => stopHold(), { passive: true });
    document.addEventListener('touchcancel', () => stopHold(), { passive: true });

    // Power toggle: OFF always resets value to 0; ON starts from 0
    pwrBtn.addEventListener('click', () => {
        isOn = !isOn;
        if (!isOn) {
            ticks = minTick; // reset to 0 (minimum) on power OFF
        }
        notify();
    });

    setBtn.addEventListener('click', () => {
        if (!isOn) return;
        setBtn.classList.remove('flashing');
        void setBtn.offsetWidth;
        setBtn.classList.add('flashing');
        setTimeout(() => setBtn.classList.remove('flashing'), 700);
    });

    notify();
    return state;
}

/* ================================================================
   BIOREACTOR CANVAS ANIMATION
================================================================ */
const canvas = document.getElementById('reactorCanvas');
const ctx    = canvas.getContext('2d');

let _impRPM  = 0;
let _impOn   = true;
let _aerPct  = 0;
let _aerOn   = true;

let angle = 0, flowOffset = 0, bubbles = [];
const MAX_BUBBLES = 300;

class Bubble {
    constructor() { this.reset(); this.y = 420 + Math.random() * 50; }
    reset() {
        this.x = 210 + (Math.random() - 0.5) * 120;
        this.y = 450;
        this.radius = Math.random() * 3 + 2;
        this.speedY = Math.random() * 2 + 1;
        this.phase  = Math.random() * Math.PI * 2;
    }
    update(rpm, aeration) {
        this.y -= this.speedY + aeration * 0.02;
        this.x += Math.sin(this.phase + this.y * 0.05) * rpm * 0.02;
        if (this.y < 155) this.reset();
    }
    draw() {
        ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle   = 'rgba(150,220,255,0.6)'; ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.8)'; ctx.lineWidth = 0.5; ctx.stroke();
    }
}
for (let i = 0; i < MAX_BUBBLES; i++) bubbles.push(new Bubble());

function drawTank() {
    ctx.fillStyle = 'rgba(200,210,220,0.5)';
    ctx.beginPath(); ctx.ellipse(210,105,125,32,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#99a'; ctx.lineWidth = 2; ctx.stroke();
    ctx.fillStyle = 'rgba(143,180,207,0.8)';
    ctx.beginPath(); ctx.ellipse(210,155,122,26,0,Math.PI,Math.PI*2); ctx.fill();
    ctx.fillStyle = 'rgba(111,151,181,0.8)'; ctx.fillRect(88,155,244,300);
    ctx.beginPath(); ctx.moveTo(88,455); ctx.quadraticCurveTo(86,495,210,495); ctx.quadraticCurveTo(334,495,332,455); ctx.fill();
}
function drawRadialFlow(rpm) {
    if (!rpm) return;
    flowOffset += rpm * 0.02;
    const op = Math.min(0.6, rpm / 250);
    ctx.strokeStyle = `rgba(100,180,255,${op})`; ctx.lineWidth = 3; ctx.setLineDash([12,15]);
    ctx.lineDashOffset =  flowOffset; ctx.beginPath(); ctx.ellipse(270,265,45,60,0,0,Math.PI*2,true);  ctx.stroke();
    ctx.lineDashOffset = -flowOffset; ctx.beginPath(); ctx.ellipse(270,390,45,50,0,0,Math.PI*2,false); ctx.stroke();
    ctx.lineDashOffset = -flowOffset; ctx.beginPath(); ctx.ellipse(150,265,45,60,0,0,Math.PI*2,false); ctx.stroke();
    ctx.lineDashOffset =  flowOffset; ctx.beginPath(); ctx.ellipse(150,390,45,50,0,0,Math.PI*2,true);  ctx.stroke();
    ctx.setLineDash([]);
}
function drawTankFront() {
    ctx.strokeStyle = '#b0b8c0'; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.moveTo(86,105); ctx.lineTo(86,455); ctx.quadraticCurveTo(86,495,210,495); ctx.quadraticCurveTo(334,495,334,455); ctx.lineTo(334,105); ctx.stroke();
    ctx.fillStyle = 'rgba(111,151,181,0.8)';
    ctx.beginPath(); ctx.ellipse(210,155,122,26,0,0,Math.PI); ctx.fill();
    ctx.strokeStyle = 'rgba(0,180,255,0.5)'; ctx.lineWidth = 1; ctx.stroke();
    ctx.strokeStyle = '#ccc'; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.ellipse(210,455,62,16,0,0,Math.PI*2); ctx.stroke();
}
function drawRushtonImpeller(cx, cy, radius, a) {
    ctx.fillStyle = '#b0b0b0'; ctx.fillRect(cx-6,62,12,cy-62);
    ctx.fillStyle = '#999'; ctx.beginPath(); ctx.ellipse(cx,cy,radius,radius*0.3,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = '#666'; ctx.lineWidth = 2; ctx.stroke();
    let blades = [];
    for (let i = 0; i < 6; i++) {
        const ba = a + i * (Math.PI/3);
        blades.push({ x: cx + radius*Math.cos(ba), y: cy + radius*0.3*Math.sin(ba), z: Math.sin(ba), angle: ba });
    }
    blades.sort((a,b) => a.z - b.z);
    blades.forEach(b => {
        const pw = Math.max(2, Math.abs(Math.sin(b.angle)) * 20);
        ctx.fillStyle = b.z > 0 ? '#d0d0d0' : '#888';
        ctx.fillRect(b.x-pw/2, b.y-15, pw, 30);
        ctx.strokeStyle = '#666'; ctx.lineWidth = 1; ctx.strokeRect(b.x-pw/2, b.y-15, pw, 30);
    });
    ctx.fillStyle = '#ccc'; ctx.beginPath(); ctx.ellipse(cx,cy,12,4,0,0,Math.PI*2); ctx.fill();
}
function drawTopCap() {
    const gb = ctx.createLinearGradient(86,0,334,0);
    gb.addColorStop(0,'#888'); gb.addColorStop(0.5,'#fff'); gb.addColorStop(1,'#777');
    ctx.fillStyle = gb;
    ctx.beginPath(); ctx.ellipse(210,105,127,34,0,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#555'; ctx.lineWidth=2; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(91,105); ctx.quadraticCurveTo(91,62,210,62); ctx.quadraticCurveTo(329,62,329,105); ctx.fill(); ctx.stroke();
    const gm = ctx.createLinearGradient(180,0,240,0);
    gm.addColorStop(0,'#555'); gm.addColorStop(0.5,'#aaa'); gm.addColorStop(1,'#444');
    ctx.fillStyle = gm; ctx.fillRect(185,18,50,44); ctx.strokeRect(185,18,50,44);
    ctx.fillStyle = '#333'; ctx.beginPath(); ctx.ellipse(210,18,25,8,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = gb;
    ctx.beginPath(); ctx.moveTo(118,83); ctx.lineTo(118,48); ctx.lineTo(133,48); ctx.lineTo(133,88); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.ellipse(125.5,48,7.5,3,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(278,88); ctx.lineTo(278,53); ctx.lineTo(298,53); ctx.lineTo(298,83); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.ellipse(288,53,10,4,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
}
function animateBio() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const rpm    = _impOn ? _impRPM : 0;
    const aerate = _aerOn ? _aerPct : 0;
    angle += rpm * 0.001;
    drawTank();
    drawRadialFlow(rpm);
    const active = Math.floor((aerate/100)*MAX_BUBBLES);
    for (let i = 0; i < active; i++) { bubbles[i].update(rpm,aerate); bubbles[i].draw(); }
    drawRushtonImpeller(210,330,52,angle);
    drawTankFront();
    drawTopCap();
    requestAnimationFrame(animateBio);
}
animateBio();

/* ================================================================
   IMPELLER + AERATION
================================================================ */
const impDispEl = document.getElementById('impellerValueDisplay');
const aerDispEl = document.getElementById('aerationValueDisplay');

makeController({
    pwrId:'impellerPwr', upId:'impellerUp', downId:'impellerDown', setId:'impellerSet',
    screenId:'impellerScreen', unitId:'impellerUnit',
    initValue:0, min:0, max:250, step:1, decimals:0,
    onUpdate: s => {
        _impOn = s.on;
        _impRPM = s.value;
        impDispEl.innerHTML = `${s.value} <span class="unit-label">RPM</span>`;
    }
});
makeController({
    pwrId:'aerationPwr', upId:'aerationUp', downId:'aerationDown', setId:'aerationSet',
    screenId:'aerationScreen', unitId:'aerationUnit',
    initValue:0, min:0, max:100, step:1, decimals:0,
    onUpdate: s => {
        _aerOn = s.on;
        _aerPct = s.value;
        aerDispEl.innerHTML = `${s.value} <span class="unit-label">%</span>`;
    }
});

/* ================================================================
   4 PERISTALTIC PUMPS
================================================================ */
const pumpNames  = ['Acid Pump','Base Pump','Feed Pump','Antifoam Pump'];
const pumpColors = ['#e74c3c',  '#3498db',  '#2ecc71',  '#f1c40f'];
const pumpCont   = document.getElementById('pumpControlsContainer');

pumpNames.forEach((name, i) => {
    const card = document.createElement('div');
    card.classList.add('pump-card');
    card.id = `pump-${i}`;
    card.innerHTML = `
        <div class="pump-title" style="color:${pumpColors[i]}">${name}</div>
        <div class="pump-svg-container">
            <svg viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg">
                <path d="M480 370 L200 370 A170 170 0 0 1 200 30 L480 30" fill="#dcdcdc" stroke="#bcbcbc" stroke-width="2"/>
                <path d="M480 345 L200 345 A145 145 0 0 1 200 55 L480 55" fill="none" stroke="${pumpColors[i]}" stroke-width="28" stroke-linecap="round"/>
                <path d="M480 345 L200 345 A145 145 0 0 1 200 55 L480 55" fill="none" stroke="#fff" opacity="0.4" stroke-width="22" stroke-linecap="round"/>
                <path class="arrows" d="M480 345 L200 345 A145 145 0 0 1 200 55 L480 55" fill="none" stroke="${pumpColors[i]}" stroke-width="4" stroke-dasharray="2,10"/>
                <g class="rotor-system">
                    <path d="M200,200 L200,60 M200,200 L321,270 M200,200 L79,270" fill="none" stroke="#666" stroke-width="45" stroke-linejoin="round" stroke-linecap="round"/>
                    <circle cx="200" cy="200" r="25" fill="#555"/>
                    <circle cx="200" cy="200" r="10" fill="#333"/>
                    <g><circle cx="200" cy="60" r="42" fill="#555" stroke="#333" stroke-width="3"/><circle cx="200" cy="60" r="8" fill="#222"/></g>
                    <g><circle cx="321" cy="270" r="42" fill="#555" stroke="#333" stroke-width="3"/><circle cx="321" cy="270" r="8" fill="#222"/></g>
                    <g><circle cx="79"  cy="270" r="42" fill="#555" stroke="#333" stroke-width="3"/><circle cx="79"  cy="270" r="8" fill="#222"/></g>
                </g>
            </svg>
        </div>
        <div class="pump-speed-label">Speed (RPM)</div>
        <div class="pump-rpm-display" id="pumpDisp-${i}">0 <span class="unit-label">RPM</span></div>
        <div class="mini-controller">
            <div class="mini-panel">
                <div class="mini-screen">
                    <div class="mini-screen-value" id="pumpScreen-${i}">0</div>
                    <div class="mini-screen-unit" id="pumpUnit-${i}">RPM</div>
                </div>
                <div class="four-btn-row">
                    <button class="ctrl-btn pwr-btn" id="pumpPwr-${i}" title="Power/Off">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                    </button>
                    <button class="ctrl-btn" id="pumpUp-${i}">▲</button>
                    <button class="ctrl-btn" id="pumpDown-${i}">▼</button>
                    <button class="ctrl-btn set-btn" id="pumpSet-${i}">SET</button>
                </div>
            </div>
        </div>
    `;
    pumpCont.appendChild(card);
});

// Wire pump controllers after DOM insertion
pumpNames.forEach((name, i) => {
    const card   = document.getElementById(`pump-${i}`);
    const rotor  = card.querySelector('.rotor-system');
    const arrows = card.querySelector('.arrows');
    const dispEl = document.getElementById(`pumpDisp-${i}`);

    makeController({
        pwrId:`pumpPwr-${i}`, upId:`pumpUp-${i}`, downId:`pumpDown-${i}`, setId:`pumpSet-${i}`,
        screenId:`pumpScreen-${i}`, unitId:`pumpUnit-${i}`,
        initValue:0, min:0, max:100, step:1, decimals:0,
        onUpdate: s => {
            const displayVal = s.value;
            dispEl.innerHTML = `${displayVal} <span class="unit-label">RPM</span>`;
            const running = s.on && s.value > 0;
            rotor.style.animationPlayState  = running ? 'running' : 'paused';
            arrows.style.animationPlayState = running ? 'running' : 'paused';
            if (running) {
                const d = 60 / s.value;
                rotor.style.animationDuration  = d + 's';
                arrows.style.animationDuration = (d/2) + 's';
            }
        }
    });
});

/* ================================================================
   THERMOMETER
================================================================ */
const cDisp = document.getElementById('cVal');
const fDisp = document.getElementById('fVal');
const fluid = document.getElementById('fluidCol');
const bulb  = document.getElementById('bulbFluid');
const scaleG = document.getElementById('scaleLines');

const START_Y = 495, END_Y = 85, TOTAL_PX = START_Y - END_Y;

(function drawScale() {
    let lines = '';
    for (let i = 0; i <= 100; i += 2) {
        const y       = START_Y - (i/100*TOTAL_PX);
        const isMajor = i % 10 === 0;
        lines += `<line x1="${isMajor?85:100}" y1="${y}" x2="110" y2="${y}" class="${isMajor?'major-tick':'minor-tick'}"/>`;
        if (isMajor) lines += `<text x="80" y="${y+4}" text-anchor="end" class="tick-label">${i}</text>`;
        const fv = Math.round(i*9/5+32);
        lines += `<line x1="130" y1="${y}" x2="${isMajor?155:140}" y2="${y}" class="${isMajor?'major-tick':'minor-tick'}"/>`;
        if (isMajor) lines += `<text x="160" y="${y+4}" text-anchor="start" class="tick-label">${fv}</text>`;
    }
    scaleG.innerHTML = lines;
})();

function getHeatColor(t) {
    if (t < 30) return '#3182ce';
    if (t < 70) return '#38a169';
    return '#e53e3e';
}
function syncThermo(val) {
    cDisp.innerText = val.toFixed(1);
    fDisp.innerText = (val * 9/5 + 32).toFixed(1);
    const h = (val/100)*TOTAL_PX;
    fluid.setAttribute('height', h);
    fluid.setAttribute('y', START_Y - h);
    const c = getHeatColor(val);
    fluid.setAttribute('fill', c);
    bulb.setAttribute('fill', c);
}

makeController({
    pwrId:'tempPwr', upId:'tempUp', downId:'tempDown', setId:'tempSet',
    screenId:'tempScreen', unitId:'tempUnit',
    initValue:0, min:0, max:100, step:0.1, decimals:1,
    onUpdate: s => {
        syncThermo(s.value);
        cDisp.innerText = s.value.toFixed(1);
        fDisp.innerText = (s.value * 9/5 + 32).toFixed(1);
    }
});
syncThermo(0);

/* ================================================================
   pH METER
================================================================ */
(function initPH() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg   = document.getElementById("ph-meter");
    const cx = 300, cy = 300;
    const ir = 100, or = 180, tir = 182, tor = 220, br = 235;

    const phColors = [
        "#D80027","#ED1C24","#F26522","#F7931E","#FFC20E",
        "#FFF200","#C4D82D","#5CB85C","#00A651","#00A99D",
        "#0071BC","#2E3192","#4B0082","#662D91","#4A148C"
    ];

    function pol(cx, cy, r, deg) {
        const rad = deg*Math.PI/180;
        return { x: cx+r*Math.cos(rad), y: cy+r*Math.sin(rad) };
    }
    function wedge(cx,cy,r1,r2,sa,ea) {
        const p1=pol(cx,cy,r2,sa), p2=pol(cx,cy,r2,ea), p3=pol(cx,cy,r1,ea), p4=pol(cx,cy,r1,sa);
        return `M${p1.x} ${p1.y} A${r2} ${r2} 0 0 1 ${p2.x} ${p2.y} L${p3.x} ${p3.y} A${r1} ${r1} 0 0 0 ${p4.x} ${p4.y} Z`;
    }
    function el(tag,attrs) {
        const e = document.createElementNS(svgNS,tag);
        Object.entries(attrs).forEach(([k,v]) => e.setAttribute(k,v));
        return e;
    }

    for (let i = 0; i <= 14; i++) {
        const sa=180+i*12, ea=180+(i+1)*12, mid=sa+6;
        svg.appendChild(el('path',{d:wedge(cx,cy,ir,or,sa,ea), fill:phColors[i]}));
        svg.appendChild(el('path',{d:wedge(cx,cy,tir,tor,sa,ea), fill:'#e0e0e0', stroke:'#fff', 'stroke-width':'2'}));
        const tp = pol(cx,cy,(tir+tor)/2,mid);
        const nt = el('text',{x:tp.x, y:tp.y, 'text-anchor':'middle', 'dominant-baseline':'central',
            'font-size':'18','font-weight':'bold','fill':'#333', transform:`rotate(${mid+90},${tp.x},${tp.y})`});
        nt.textContent = i;
        svg.appendChild(nt);
    }

    function bracket(sv,ev,label,rot) {
        const sa=180+sv*12+1, ea=180+(ev+1)*12-1, mid=(sa+ea)/2;
        const p1=pol(cx,cy,br,sa), p2=pol(cx,cy,br,ea);
        const l1=pol(cx,cy,br-8,sa), l2=pol(cx,cy,br-8,ea);
        svg.appendChild(el('path',{d:`M${l1.x} ${l1.y} L${p1.x} ${p1.y} A${br} ${br} 0 0 1 ${p2.x} ${p2.y} L${l2.x} ${l2.y}`,
            fill:'none', stroke:'#888','stroke-width':'1.5'}));
        const tp=pol(cx,cy,br+20,mid);
        const tx=el('text',{x:tp.x,y:tp.y,'text-anchor':'middle','dominant-baseline':'central',
            'font-size':'18','font-family':'sans-serif','fill':'#555',transform:`rotate(${mid+90+rot},${tp.x},${tp.y})`});
        tx.textContent = label; svg.appendChild(tx);
    }
    bracket(0,6,'Acidic',-15); bracket(7,7,'Neutral',0); bracket(8,14,'Alkaline',15);

    const phT = el('text',{x:cx,y:cy-40,'text-anchor':'middle','font-size':'55','font-weight':'900','fill':'#333','letter-spacing':'-2'});
    phT.textContent = 'pH'; svg.appendChild(phT);
    const scT = el('text',{x:cx,y:cy-10,'text-anchor':'middle','font-size':'30','font-weight':'bold','fill':'#555','letter-spacing':'-1'});
    scT.textContent = 'scale'; svg.appendChild(scT);

    const ag = el('g',{id:'arrow-group'});
    const apath = el('path',{d:`M${cx} ${cy-(tor+8)} L${cx-10} ${cy-(tor+28)} L${cx+10} ${cy-(tor+28)} Z`, fill:'#333'});
    ag.appendChild(apath); svg.appendChild(ag);

    function updateArrow(val) {
        document.getElementById('arrow-group').setAttribute('transform', `rotate(${186+val*12-270},${cx},${cy})`);
        const cv = document.getElementById('current-val');
        cv.textContent = parseFloat(val).toFixed(1);
        cv.style.color = phColors[Math.min(Math.floor(val), phColors.length-1)];
    }
    updateArrow(0);

    makeController({
        pwrId:'phPwr', upId:'phUp', downId:'phDown', setId:'phSet',
        screenId:'phScreen', unitId:'phUnit',
        initValue:0.0, min:0, max:14, step:0.1, decimals:1,
        onUpdate: s => {
            updateArrow(s.value);
        }
    });
})();
</script>
</body>
</html>
